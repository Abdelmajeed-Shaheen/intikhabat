{% extends "common_base.html" %}
{% load staticfiles %}


{% block extra_content %}
  <!-- ======= main Section ======= -->
  <section id="hero">
    <div class="hero-container">
      <div class="wow fadeIn">
        <div class="actions">
          <i class="fa fa-star fa-2x mx-1 star-icon" aria-hidden="true"></i>
          <i class="fa fa-star fa-2x mx-1 star-icon" aria-hidden="true"></i>
          <i class="fa fa-star fa-2x mx-1  star-icon" aria-hidden="true"></i>
          <i class="fa fa-star fa-2x mx-1 star-icon" aria-hidden="true"></i>
          <i class="fa fa-star fa-2x mx-1 star-icon" aria-hidden="true"></i>
        </div>
        <h1>انتخابات مجلس النواب الاردني</h1>
        <div class="actions">
          <button  class="btn btn-success  mx-3 my-2" data-toggle="modal" data-target="#candidateLoginForm">ادارة الحملة</button>
          <button  class="btn btn-success  mx-3 my-2" data-toggle="modal" data-target="#doyouhave">ناخب</button>
          <button  class="btn btn-success  mx-3 my-2" data-toggle="modal" data-target="#video1">البث المباشر</button>
          <button  class="btn btn-success  mx-3 my-2" data-toggle="modal" data-target="#video1">الاحصاء</button>
          <button  class="btn btn-success  mx-3 my-2" data-toggle="modal" data-target="#video1">المرشحين</button>
        </div>
        <div class="actions">
          <i class="fab fa-google-play fa-2x star-icon"></i>
          <i class="fab fa-app-store star-icon"></i>
        </div>
      </div>
    </div>
  </section><!-- End main -->
<!-- candidate login -->
  <div class="modal fade" id="candidateLoginForm" tabindex="-1" role="dialog" aria-labelledby="candidateloginformlabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginformlabel">تسجيل دخول</h5>
          </div>

          <div class="modal-body">
            <form id="#voterloginform" method="POST" action="{% url 'userlogin' %}">
            {% csrf_token %}
              <div class="form-group text-aligner">
                <label for="recipient-name" class="col-form-label">رقم الهاتف</label>
                {{candidate_login_form.candidate_username}}
              </div>
              <div class="form-group text-aligner">
              <input type="hidden" value="camp" id="login_to">
                <label for="message-text" class="col-form-label">كلمة السر</label>

                {{candidate_login_form.candidate_password}}
              </div>

            </form>
          </div>

        <div class="modal-footer">
          <button id="candidate-submit-form" class="btn btn-info btn-block">تسجيل دخول</button></div>
      </div>
    </div>
  </div>

<!--voter login  -->
<div class="modal fade" id="voterLoginForm" tabindex="-1" role="dialog" aria-labelledby="voterloginformlabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginformlabel">تسجيل دخول</h5>
      </div>
        <div class="modal-body">
          <form id="loginform" method="POST" action="{% url 'userlogin' %}">
          {% csrf_token %}
            <div class="form-group text-aligner">
              <label for="recipient-name" class="col-form-label">رقم الهاتف</label>
              {{login_form.username}}
            </div>
            <div class="form-group text-aligner">
              <label for="message-text" class="col-form-label">كلمة السر</label>
              {{login_form.password}}
            </div>

          </form>
        </div>

      <div class="modal-footer">
        <button id="submit-form" class="btn btn-info btn-block">تسجيل دخول</button>
      </div>
    </div>
  </div>
</div>
<!-- do you have an account modal -->
<div class="modal fade" id="doyouhave" tabindex="-1" role="dialog" aria-labelledby="doyouhavelabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div calss="row">
          <div class="text-center"><h5>هل لديك حساب ؟</h5></div>
        </div>
      </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 "><button class="btn btn-info btn-block mx-2 my-2"data-toggle="modal" data-target="#voterLoginForm" data-dismiss="modal">نعم</button></div>
            <div class="col-md-6 "><button class="btn btn-info btn-block mx-2 my-2"data-toggle="modal" data-target="#elastic" data-dismiss="modal">لا</button></div>
          </div>
        </div>
    </div>
  </div>
</div>




<!-- elastic search modal -->


<div class="modal fade" id="elastic" tabindex="-1" role="dialog" aria-labelledby="elasticlabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div calss="row">
          <div class="text-center">
          <h5>ادخل اسمك </h5>
         
          <label style="color:red; font-weight:bold;">يرجى ادخال الاسم حسب الهوية الشخصية</label>
          </div>
        </div>
      </div>
        <div class="modal-body">
          <div class="row">
          <div class="col-md-6 ">
          <input  type="text" placeholder="يرجى ادخال الاسم من اربع مقاطع" id="elasticName" class="form-control">
          
          </div>
            <div class="col-md-6 "><button class="btn btn-info btn-block mx-2 my-2" id="elasticSearch" >بحث</button></div>
            
          </div>
        </div>
    </div>
  </div>
</div>
<!-- regmodal -->
 <div class="modal" id="regModal" tabindex="-1" role="dialog" aria-labelledby="regLable" aria-hidden="true" style="overflow-y:scroll;">
  <div class="modal-dialog modal-dialog-center" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="regLable">مرحبا بك </h5>
      </div>
      <div class="modal-body text-aligner">
        <form id="createProfileForm" class="needs-validation" novalidate>
          <div class="form-row">


            <div class="col-md-6 mb-3">
              <input type="text" disabled value="fullname" id="full_name" class="form-control">
            </div>
              <div class="col-md-6 mb-3">
              <input type="text" disabled value="fullname" id="department" class="form-control">
            </div>
              <div class="col-md-6 mb-3">
              <input type="text" disabled value="fullname" id="election_place" class="form-control">
            </div>
          </div>
          <div class="form-row">
            <div class="col-md-5 mb-3">
              {{voter_reg_form.mobile_number}}
            </div>
            <div class="col-md-7 mb-3">
              {{voter_reg_form.email}}
            </div>
          </div>
          <div class="form-row mt-2">
              <label >تاريخ الميلاد</label></div>
          <div class="form-row">
              {{voter_reg_form.dob}}
          </div>
          <div class="form-row mt-2">
            <div class="col-md-4">
              <label >الجنس</label>
              {{voter_reg_form.gender}}
            </div>
            <div class="col-md-4">
              <label >قطاع العمل</label>
              {{voter_reg_form.work}}
            </div>
          </div>

          <div class="form-row mt-5">
            <div class="col-sm-8">
              <input type="password" id="pwd" required placeholder="كلمة السر" class="form-control" data-field-name="كلمة السر">
              <div class="m-2 field-warning">
                <span>* يرجى مراعاة وجود ارقام واحرف باللغة الانجليزية</span>
              </div>
              <div class="m-2 field-warning">
                <span>* يجب ان تتكون كلمة السر من ٨ خانات</span>
              </div>
            </div>
          </div>
        </form>
        <span style="color:red;font-weight:bolder;">يستخدم رقم الهاتف و كلمة السر للدخول الى الصفحة مرة اخرى</span>
        <br>
        <span style="color:red;font-weight:bolder;">هذه المعلومات غير رسمية</span>
        <button class="btn btn-info btn-block mt-3" id="register">تسجيل</button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">اغلاق</button>
      </div>
    </div>
  </div>
</div>

<!-- success modal -->
<div class="modal fade" id="succesModal" tabindex="-1" role="dialog" aria-labelledby="successModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">


      </div>
      <div class="modal-body">
        <div class="alert alert-success" role="alert">
          <h4 class="alert-heading">تم التسجيل بنجاح</h4>

        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">اغلاق</button>

      </div>
    </div>
  </div>
  </div>

  <div class="modal fade" id="errorMessage" tabindex="-1" role="dialog" aria-labelledby="successModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">


        </div>
        <div class="modal-body">
          <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading" id="message" ></h4>

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">اغلاق</button>

        </div>
      </div>
    </div>
    </div>

    <!-- select candidate Modal -->
    <div class="modal fade" id="video1" tabindex="-1" role="dialog" aria-labelledby="video1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
      <div class="modal-body">
        <div class="embed-responsive embed-responsive-16by9">
  <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/v64KOxKVLVg" allowfullscreen></iframe>      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">اغلاق</button>
      </div>
    </div>
  </div>

{% endblock  %}

{% block main %}

{% endblock %}

{% block js %}
<script>
  $("#submit-form").on('click',function(){
    pwd=$("#id_password").val()
    user=$("#id_username").val()
    $.ajax({
      url:"{% url 'userlogin' %}",
      type:'POST',
      dataType:'JSON',
      data:{
        username:user,
        password:pwd,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success:function (result) {
        if (result.error){
          $("#message").text(result.error)
          $("#errorMessage").modal('show')
        }
        else{
          window.location.replace(result.redirect_to);
        }
      },
    })
  })

  $("#candidate-submit-form").on('click',function(){
    pwd=$("#id_candidate_password").val()
    user=$("#id_candidate_username").val()
    login_to=$("#login_to").val()
    $.ajax({
      url:"{% url 'userlogin' %}",
      type:'POST',
      dataType:'JSON',
      data:{
        username:user,
        password:pwd,
        login_to:login_to,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success:function (result) {

        if (result.error){
          $("#message").text(result.error)
          $("#errorMessage").modal('show')
        }
        else{
          window.location.replace(result.redirect_to);
        }

      },
    })

  })


  var checker=false
  function checkField(formFields,selecFields){
  inputFields=formFields
  selectFields

  inputFields.each(function(){
    field=$(this)
      if (!field.val()){
        $("#message").append("<span>"+field.data("field-name")+" مطلوب"+"</span> <br>");
        $("#errorMessage").modal("show");

        checker=false
      }

      else{
        checker=true

      }

  })

  selectFields.each(function(){
    option=$(this)
    console.log(option.val())
      if (!option.val() || option.val()==""){
        $("#message").append("<span>"+option.data("field-name")+" مطلوب"+"</span> <br>");
        $("#errorMessage").modal("show");

        checker=false

      }

      else{
        checker=true

      }

  })

  return checker
}


$('#register').on('click',function(){

  formFields=$('#createProfileForm').find('input')
  selectFields=$('#createProfileForm').find('select option:selected')

  fieldChecker=checkField(formFields,selectFields)

  if (fieldChecker){
    userprofile= new Object()
    userprofile.pwd=$('#pwd').val()
    userprofile.full_name=$("#full_name").val()
    userprofile.mobile_number=$("#id_mobile_number").val()
    userprofile.whatsapp_number=$("#id_whatsapp_number").val()
    userprofile.election_place=$("#election_place").val()
    userprofile.dept=$("#department").val()
    userprofile.work=$("#id_work option:selected").val()
    userprofile.gender=$("#id_gender option:selected").val()
    day=$('#id_dob_day').val()
    month=$('#id_dob_month').val()
    year=$('#id_dob_year').val()
    userprofile.dob=(year+"-"+month+"-"+day)
    userprofile.email=$("#id_email").val()
    userjson=JSON.stringify(userprofile)
    $.ajax({
      url:"{% url 'create-voter' %}",
      type:"POST",
      data:{
        csrfmiddlewaretoken:'{{csrf_token}}',
        voter:userjson
      },
      success:function(result){
        if (result.error){
            $("#message").text(result.error)
            $("#errorMessage").modal('show')

          }
          else{
            window.location.replace(result.redirect_to);

          }

      },
      error:function(result){
        alert("حدث خطأ بالتسجيل")
      }
    })
    }

})

$(document).ready(function(){
  $('#id_dob_month').addClass('form-control date-input m-2')
  $('#id_dob_day').addClass('form-control  date-input m-2')
  $('#id_dob_year').addClass('form-control date-input m-2')
  $('#id_gender').addClass('form-control m-2')
  $('#id_work').find("option:selected").attr("data-field-name","العمل")
})

$(document).on('change', '#gover', function () {
    element = $('#gover option:selected').val();
    $.ajax(
        {
        type: "GET",
        url: "{% url 'get_gover_dept' %}",
        data: {
        'gover_id': element
        },
        dataType: 'JSON',
            success: function (result) {
            $("#dept").empty();
            $("#dept").append('<option value=""> كل الدوائر</option>');
            $(result).each(function (index, value) {
            $("#dept").append('<option value="' + value.id + '">' + value.name + '</option>');
            });

            }
        }
    );
});

$(document).on('change', '#dept', function () {
    element = $('#dept option:selected').val();
    $.ajax(
        {
        type: "GET",
        url: "{% url 'get_dept_area' %}",
        data: {
        'dept_id': element
        },
        dataType: 'JSON',
            success: function (result) {
            $("#area").empty();
            $("#area").append('<option value=""> كل المناطق</option>');
            $(result).each(function (index, value) {
            $("#area").append('<option value="' + value.id + '">' + value.name + '</option>');
            });

            }
        }
    );
});

$("#id_dob_month").before($("#id_dob_day"))


$("#elasticSearch").on("click",function(){

    name=$("#elasticName").val()
    var spaceCount = (name.split(" ").length - 1)
  

    if(spaceCount>2){
      doAnAjax( name, function(myRtn) {
      
        if (myRtn === "Success") {
          console.log( "success: "+myRtn)
        } else {
              console.log("Opps! Ajax Error");
        }
    }); 

    }
    else{
      $("#message").empty()
      $("#message").text("يرجى التأكد ان يكون الاسم من اربع مقاطع على الاقل")
      $("#errorMessage").modal("show")
    }


});

// pass callback as third parameter to doAnAjax()

function doAnAjax( data, callBack) {
    $.ajax({
        url: '{% url "check-user-elastic" %}',
        async: true,
        dataType: 'JSON',
        type: "GET",
        data: {
          name:data
        },
        cache: false,
        success: function(data, textStatus, xhr) {
            
            result=data[0]
            if (!result.success){
              $("#message").empty()
              $("#message").text(result.message)
              $("#errorMessage").modal("show")
            }
            else{
              $("#regModal").modal("show")
              $("#elastic").modal("hide")
              $("#full_name").val(result.name)
              $("#department").val(result.circle_name)
              $("#election_place").val(result.election_place_name)
            }
            myRtnA = "Success"
            return callBack( myRtnA );  // return callBack() with myRtna
        },
        error: function(xhr, textStatus, errorThrown) {
        
            console.log("opps: " + textStatus + " : " + errorThrown)
            myRtnA = "Error"
            return callBack ( myRtnA ); // return callBack() with myRtna
        }
    });
}






</script>
{% endblock %}
